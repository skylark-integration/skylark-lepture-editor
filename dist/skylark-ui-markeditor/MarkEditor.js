/**
 * skylark-ui-markeditor - The skylark markdown editor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-markeditor/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-utils-dom/browser","skylark-utils-dom/noder","skylark-utils-dom/eventer","skylark-utils-dom/finder","skylark-utils-dom/query","skylark-utils-md/Parser","skylark-ui-swt/ui","skylark-ui-swt/Widget"],function(e,t,n,r,o,i,a,l,c,s){function u(e){return e=q?e.replace("Ctrl","Cmd"):e.replace("Cmd","Ctrl")}function d(e,t){t=t||{};var n=document.createElement("a"),r=t.shortcut||A[e];return r&&(r=u(r),n.title=r,n.title=n.title.replace("Cmd","⌘"),q&&(n.title=n.title.replace("Alt","⌥"))),n.className=t.className||"editor-icon-"+e,n}function m(){return el=document.createElement("i"),el.className="separator",el.innerHTML="|",el}function f(e,t){t=t||e.getCursor("start");var n=e.getTokenAt(t);if(!n.type)return{};for(var r,o,i=n.type.split(" "),a={},l=0;l<i.length;l++)r=i[l],"strong"===r?a.bold=!0:"variable-2"===r?(o=e.getLine(t.line),/^\s*\d+\.\s/.test(o)?a["ordered-list"]=!0:a["unordered-list"]=!0):"atom"===r?a.quote=!0:"em"===r&&(a.italic=!0);return a}function g(e){var t=e.codemirror.getWrapperElement(),n=document,r=n.fullScreen||n.mozFullScreen||n.webkitIsFullScreen,o=function(){t.requestFullScreen?t.requestFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)},i=function(){n.cancelFullScreen?n.cancelFullScreen():n.mozCancelFullScreen?n.mozCancelFullScreen():n.webkitCancelFullScreen&&n.webkitCancelFullScreen()};r?i&&i():o()}function h(e){T(e,"bold","**")}function p(e){T(e,"italic","*")}function v(e){T(e,"code","```\r\n","\r\n```")}function k(e){var t=e.codemirror;F(t,"quote")}function b(e){var t=e.codemirror;F(t,"unordered-list")}function w(e){var t=e.codemirror;F(t,"ordered-list")}function C(e){var t=e.codemirror,n=f(t);E(t,n.link,"[","](http://)")}function S(e){var t=e.codemirror,n=f(t);E(t,n.image,"![","](http://)")}function L(e){var t=e.codemirror;t.undo(),t.focus()}function N(e){var t=e.codemirror;t.redo(),t.focus()}function y(e){var t=e.toolbar.preview,n=e.constructor.markdown,r=e.codemirror,o=r.getWrapperElement(),i=o.lastChild;/editor-preview/.test(i.className)||(i=document.createElement("div"),i.className="editor-preview",o.appendChild(i)),/editor-preview-active/.test(i.className)?(i.className=i.className.replace(/\s*editor-preview-active\s*/g,""),t.className=t.className.replace(/\s*active\s*/g,"")):(setTimeout(function(){i.className+=" editor-preview-active"},1),t.className+=" active");var a=r.getValue();i.innerHTML=n(a)}function E(e,t,n,r){var o,i=e.getCursor("start"),a=e.getCursor("end");t?(o=e.getLine(i.line),n=o.slice(0,i.ch),r=o.slice(i.ch),e.setLine(i.line,n+r)):(o=e.getSelection(),e.replaceSelection(n+o+r),i.ch+=n.length,a.ch+=n.length),e.setSelection(i,a),e.focus()}function F(e,t){for(var n=f(e),r=e.getCursor("start"),o=e.getCursor("end"),i={quote:/^(\s*)\>\s+/,"unordered-list":/^(\s*)(\*|\-|\+)\s+/,"ordered-list":/^(\s*)\d+\.\s+/},a={quote:"> ","unordered-list":"* ","ordered-list":"1. "},l=r.line;l<=o.line;l++)!function(r){var o=e.getLine(r);o=n[t]?o.replace(i[t],"$1"):a[t]+o,e.setLine(r,o)}(l);e.focus()}function T(e,t,n,r){r="undefined"==typeof r?n:r;var o,i=e.codemirror,a=f(i),l=n,c=r,s=i.getCursor("start"),u=i.getCursor("end");a[t]?(o=i.getLine(s.line),l=o.slice(0,s.ch),c=o.slice(s.ch),startRegex=new RegExp("/^(.*)?(*|_){"+n.length+"}(S+.*)?$/","g"),l=l.replace(startRegex,"$1$3"),endRegex=new RegExp("/^(.*S+)?(*|_){"+r.length+"}(s+.*)?$/","g"),c=c.replace(endRegex,"$1$3"),s.ch-=n.length,u.ch-=r.length,i.setLine(s.line,l+c)):(o=i.getSelection(),i.replaceSelection(l+o+c),s.ch+=n.length,u.ch+=r.length),i.setSelection(s,u),i.focus()}function M(e){var t=/[a-zA-Z0-9_\u0392-\u03c9]+|[\u4E00-\u9FFF\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\uac00-\ud7af]+/g,n=e.match(t),r=0;if(null===n)return r;for(var o=0;o<n.length;o++)r+=n[o].charCodeAt(0)>=19968?n[o].length:1;return r}var q=/Mac/.test(navigator.platform),A={"Cmd-B":h,"Cmd-I":p,"Cmd-K":C,"Cmd-Alt-I":S,"Cmd-'":k,"Cmd-Alt-L":w,"Cmd-L":b},x=[{name:"bold",action:h},{name:"italic",action:p},{name:"code",action:v},"|",{name:"quote",action:k},{name:"unordered-list",action:b},{name:"ordered-list",action:w},"|",{name:"link",action:C},{name:"image",action:S},"|",{name:"info",action:"http://lab.lepture.com/editor/markdown"},{name:"preview",action:y},{name:"fullscreen",action:g}],I=c.MarkEditor=s.inherit({klassName:"MarkEditor",_construct:function(e){e=e||{},e.element&&(this.element=e.element),e.toolbar=e.toolbar||I.toolbar,e.hasOwnProperty("status")||(e.status=["lines","words","cursor"]),this.options=e,this.element&&this.render()},render:function(e){if(e||(e=this.element||document.getElementsByTagName("textarea")[0]),!this._rendered||this._rendered!==e){this.element=e;var t=this.options,n=this,r={};for(var o in A)!function(e){r[u(e)]=function(t){A[e](n)}}(o);r.Enter="newlineAndIndentContinueMarkdownList",r.Tab="tabAndIndentContinueMarkdownList",r["Shift-Tab"]="shiftTabAndIndentContinueMarkdownList",this.codemirror=CodeMirror.fromTextArea(e,{mode:"markdown",theme:"paper",tabSize:"2",indentWithTabs:!0,lineNumbers:!1,autofocus:!0,extraKeys:r}),t.toolbar!==!1&&this.createToolbar(),t.status!==!1&&this.createStatusbar(),this._rendered=this.element}},createToolbar:function(e){if(e=e||this.options.toolbar,e&&0!==e.length){var t=document.createElement("div");t.className="editor-toolbar";var n=this;n.toolbar={};for(var r=0;r<e.length;r++)!function(e){var r;r=e.name?d(e.name,e):"|"===e?m():d(e),e.action&&("function"==typeof e.action?r.onclick=function(t){e.action(n)}:"string"==typeof e.action&&(r.href=e.action,r.target="_blank")),n.toolbar[e.name||e]=r,t.appendChild(r)}(e[r]);var o=this.codemirror;o.on("cursorActivity",function(){var e=f(o);for(var t in n.toolbar)!function(t){var r=n.toolbar[t];e[t]?r.className+=" active":r.className=r.className.replace(/\s*active\s*/g,"")}(t)});var i=o.getWrapperElement();return i.parentNode.insertBefore(t,i),t}},createStatusbar:function(e){if(e=e||this.options.status,e&&0!==e.length){var t=document.createElement("div");t.className="editor-statusbar";for(var n,r=this.codemirror,o=0;o<e.length;o++)!function(e){var o=document.createElement("span");o.className=e,"words"===e?(o.innerHTML="0",r.on("update",function(){o.innerHTML=M(r.getValue())})):"lines"===e?(o.innerHTML="0",r.on("update",function(){o.innerHTML=r.lineCount()})):"cursor"===e&&(o.innerHTML="0:0",r.on("cursorActivity",function(){n=r.getCursor(),o.innerHTML=n.line+":"+n.ch})),t.appendChild(o)}(e[o]);var i=this.codemirror.getWrapperElement();return i.parentNode.insertBefore(t,i.nextSibling),t}},value:function(e){return e?(this.codemirror.getDoc().setValue(e),this):this.codemirror.getValue()},toggleBold:function(){h(this)},toggleItalic:function(){p(this)},toggleBlockquote:function(){k(this)},toggleUnOrderedList:function(){b(this)},toggleOrderedList:function(){w(this)},drawLink:function(){C(this)},drawImage:function(){S(this)},undo:function(){L(this)},redo:function(){N(this)},togglePreview:function(){y(this)},toggleFullScreen:function(){g(this)}});return I.toolbar=x,I.markdown=function(e){return l.parse(e)},I.toggleBold=h,I.toggleItalic=p,I.toggleBlockquote=k,I.toggleUnOrderedList=b,I.toggleOrderedList=w,I.drawLink=C,I.drawImage=S,I.undo=L,I.redo=N,I.togglePreview=y,I.toggleFullScreen=g,I});
//# sourceMappingURL=sourcemaps/MarkEditor.js.map
